name: Agent VM

env:
  PREFECT_API_KEY: ${{ secrets.PREFECT_API_KEY }}
  PREFECT_API_URL: ${{ secrets.PREFECT_API_URL }}

on:
  workflow_dispatch:
    inputs:
      GCP_CREDENTIALS_JSON:
        description: "Content of the Service Account JSON key file"
        required: true
      PREFECT_AGENT_QUEUE_NAME:
        description: "Name of the Prefect queue the agent should listen on"
        required: true
        default: "github"
      GCP_RESOURCE_REGION:
        description: "Region of project"
        required: true
        default: "northamerica-northeast1"

jobs:
  build-and-apply-deployment:
    name: Provision Prefect Agent VM

    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: "${{ inputs.GCP_CREDENTIALS_JSON }}"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Login to GAR
        uses: docker/login-action@v2
        with:
          registry: "${{ inputs.GCP_RESOURCE_REGION }}-docker.pkg.dev"
          username: _json_key
          password: ${{ inputs.GCP_CREDENTIALS_JSON }}
